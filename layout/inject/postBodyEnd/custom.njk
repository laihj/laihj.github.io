{# 相关文章功能 #}
{%- if page and page.date %}
  {%- set currentMonth = page.date.month() + 1 %}
  {%- set currentDay = page.date.date() %}
  {%- set sameDayPosts = [] %}
  {%- set allOtherPosts = [] %}
  
  {# 查找同一天的历史文章和所有其他文章 #}
  {%- for post in site.posts %}
    {%- if post.published and post._id != page._id %}
      {%- set postMonth = post.date.month() + 1 %}
      {%- set postDay = post.date.date() %}
      {%- if postMonth == currentMonth and postDay == currentDay %}
        {%- set sameDayPosts = sameDayPosts + [post] %}
      {%- endif %}
      {%- set allOtherPosts = allOtherPosts + [post] %}
    {%- endif %}
  {%- endfor %}
  
  {# 决定显示哪类文章 #}
  {%- if sameDayPosts.length > 0 %}
    {%- set relatedPosts = sameDayPosts | sort('date', true) | slice(0, 5) %}
    {%- set relatedTitle = "历史上的今天 (" + currentMonth + "月" + currentDay + "日)" %}
  {%- elif allOtherPosts.length > 0 %}
    {# 简单的"随机"效果：基于当前页面ID来选择文章 #}
    {%- set startIndex = (page._id | length) % (allOtherPosts.length - 4) %}
    {%- set relatedPosts = allOtherPosts | slice(startIndex, startIndex + 5) %}
    {%- set relatedTitle = "推荐阅读" %}
  {%- endif %}
  
  {# 显示相关文章 #}
  {%- if relatedPosts and relatedPosts.length > 0 %}
<div class="related-posts-widget">
  <div class="related-posts-title">
    <h3>{{ relatedTitle }}</h3>
  </div>
  <div class="related-posts-list">
    {%- for post in relatedPosts %}
    <div class="related-post-item">
      <div class="related-post-meta">
        <time class="related-post-date">{{ date(post.date, 'YYYY-MM-DD') }}</time>
        {%- if post.tags and post.tags.length > 0 %}
          <span class="related-post-tags">
            {%- for tag in post.tags.limit(2) %}
              <span class="related-post-tag">#{{ tag.name }}</span>
            {%- endfor %}
          </span>
        {%- endif %}
      </div>
      <h4 class="related-post-title">
        <a href="{{ url_for(post.path) }}" title="{{ post.title }}">{{ post.title }}</a>
      </h4>
      {%- if post.excerpt %}
        <p class="related-post-excerpt">{{ truncate(strip_html(post.excerpt), {length: 120, omission: '...'}) }}</p>
      {%- endif %}
    </div>
    {%- endfor %}
  </div>
</div>
  {%- endif %}
{%- endif %}